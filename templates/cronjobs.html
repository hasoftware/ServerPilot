{% extends "base.html" %} {% block title %}Cronjob Manager - Control Server{%
endblock %} {% block body %}
<div class="app-shell">
  <aside class="sidebar">
    <div style="padding: 0 1.5rem 1rem; font-weight: 600">Control Server</div>
    <nav>
      <a href="/dashboard">Dashboard</a>
      <a href="/cronjobs" class="active">Cronjob Manager</a>
      <a href="/logs">Log Server</a>
      <a href="/services">Services</a>
      <a href="/vnc">Console</a>
      <a href="#" id="logoutLink">Đăng xuất</a>
    </nav>
  </aside>
  <main class="main">
    <div
      class="flex gap-2 mb-2"
      style="justify-content: space-between; align-items: center"
    >
      <h1>Cronjob Manager</h1>
      <button class="btn btn-primary" id="btnAdd">+ Thêm Cronjob</button>
    </div>
    <div id="alert" class="alert alert-error hidden"></div>
    <div id="successAlert" class="alert alert-success hidden"></div>
    <div class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Tên</th>
              <th>URL</th>
              <th>Method</th>
              <th>Cron</th>
              <th>Log</th>
              <th>Trạng thái</th>
              <th>Thao tác</th>
            </tr>
          </thead>
          <tbody id="cronjobList"></tbody>
        </table>
      </div>
    </div>
  </main>
</div>

<!-- Modal Add/Edit -->
<div id="modalForm" class="modal-overlay hidden">
  <div class="modal">
    <h3 id="modalTitle">Thêm Cronjob</h3>
    <form id="formCronjob">
      <input type="hidden" name="id" />
      <div class="form-group">
        <label>Tên</label>
        <input type="text" name="name" required placeholder="My job" />
      </div>
      <div class="form-group">
        <label>URL</label>
        <input
          type="url"
          name="url"
          required
          placeholder="https://example.com/webhook"
        />
      </div>
      <div class="form-group">
        <label>Method</label>
        <select name="method">
          <option value="CURL">CURL</option>
          <option value="WGET">WGET</option>
          <option value="GET">GET</option>
          <option value="POST">POST</option>
        </select>
      </div>
      <div class="form-group">
        <label>Lịch chạy</label>
        <div class="cron-builder">
          <div class="cron-mode mb-2">
            <label
              ><input type="radio" name="cron_mode" value="preset" checked />
              Chọn nhanh</label
            >
            <label
              ><input type="radio" name="cron_mode" value="custom" /> Tùy
              chỉnh</label
            >
            <label
              ><input type="radio" name="cron_mode" value="manual" /> Nhập
              tay</label
            >
          </div>
          <div id="cronPreset" class="cron-block">
            <select name="cron_preset">
              <optgroup label="Theo giây">
                <option value="* * * * * *">Mỗi giây</option>
                <option value="*/5 * * * * *">Mỗi 5 giây</option>
                <option value="*/10 * * * * *">Mỗi 10 giây</option>
                <option value="*/30 * * * * *">Mỗi 30 giây</option>
              </optgroup>
              <optgroup label="Theo phút">
                <option value="* * * * *">Mỗi phút</option>
                <option value="*/5 * * * *" selected>Mỗi 5 phút</option>
                <option value="*/15 * * * *">Mỗi 15 phút</option>
                <option value="*/30 * * * *">Mỗi 30 phút</option>
              </optgroup>
              <optgroup label="Theo giờ / ngày">
                <option value="0 * * * *">Mỗi giờ (phút 0)</option>
                <option value="0 */6 * * *">Mỗi 6 giờ</option>
                <option value="0 0 * * *">Hàng ngày lúc 0:00</option>
                <option value="0 8 * * *">Hàng ngày lúc 8:00</option>
                <option value="0 0 * * 0">Hàng tuần (Chủ nhật 0:00)</option>
                <option value="0 0 1 * *">Hàng tháng (ngày 1, 0:00)</option>
              </optgroup>
            </select>
          </div>
          <div id="cronCustom" class="cron-block hidden">
            <div
              class="cron-row flex gap-2 mb-2"
              style="flex-wrap: wrap; align-items: center"
            >
              <span>Giây:</span>
              <select name="cron_sec">
                <option value="0">0</option>
                <option value="*">Mỗi giây</option>
                <option value="*/5">Mỗi 5 giây</option>
                <option value="*/10">Mỗi 10 giây</option>
                <option value="*/15">Mỗi 15 giây</option>
                <option value="*/30">Mỗi 30 giây</option>
              </select>
              <span>Phút:</span>
              <select name="cron_min">
                <option value="*">Mỗi phút</option>
                <option value="0">0</option>
                <option value="*/5">Mỗi 5 phút</option>
                <option value="*/10">Mỗi 10 phút</option>
                <option value="*/15">Mỗi 15 phút</option>
                <option value="*/30">Mỗi 30 phút</option>
                <option value="15">15</option>
                <option value="30">30</option>
                <option value="45">45</option>
              </select>
              <span>Giờ:</span>
              <select name="cron_hour">
                <option value="*">Mỗi giờ</option>
                <option value="0">0</option>
                <option value="6">6</option>
                <option value="8">8</option>
                <option value="12">12</option>
                <option value="18">18</option>
                <option value="23">23</option>
                <option value="*/6">Mỗi 6 giờ</option>
              </select>
              <span>Ngày:</span>
              <select name="cron_day">
                <option value="*">Mỗi ngày</option>
                <option value="1">1</option>
                <option value="7">7</option>
                <option value="15">15</option>
                <option value="28">28</option>
              </select>
              <span>Tháng:</span>
              <select name="cron_month">
                <option value="*">Mỗi tháng</option>
                <option value="1">1</option>
                <option value="6">6</option>
                <option value="12">12</option>
              </select>
              <span>Thứ:</span>
              <select name="cron_dow">
                <option value="*">Mỗi ngày</option>
                <option value="0">Chủ nhật</option>
                <option value="1">Thứ 2</option>
                <option value="5">Thứ 6</option>
                <option value="6">Thứ 7</option>
              </select>
            </div>
          </div>
          <div id="cronManual" class="cron-block hidden">
            <input
              type="text"
              name="cron_manual"
              placeholder="*/5 * * * * hoặc */10 * * * * * (có giây)"
              style="font-family: monospace; width: 100%"
            />
          </div>
          <div class="text-muted mt-1" style="font-size: 0.85rem">
            Cron: <code id="cronPreview">*/5 * * * *</code>
          </div>
        </div>
        <input type="hidden" name="cron_expression" required />
      </div>
      <div class="form-group">
        <label
          ><input type="checkbox" name="enable_log" checked /> Bật log</label
        >
      </div>
      <div class="form-group">
        <label
          ><input type="checkbox" name="enabled" checked id="enabledCheck" />
          Bật cronjob</label
        >
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="btnCancel">
          Hủy
        </button>
        <button type="submit" class="btn btn-primary">Lưu</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Logs -->
<div id="modalLogs" class="modal-overlay hidden">
  <div class="modal" style="max-width: 700px">
    <h3>Log: <span id="logJobName"></span></h3>
    <div class="log-list" id="logList"></div>
    <div class="modal-actions mt-2">
      <button type="button" class="btn btn-secondary" id="btnCloseLogs">
        Đóng
      </button>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  const alertEl = document.getElementById("alert");
  const successEl = document.getElementById("successAlert");

  document.getElementById("logoutLink").addEventListener("click", async (e) => {
    e.preventDefault();
    await fetch("/api/auth/logout", { method: "POST", credentials: "include" });
    window.location.href = "/login";
  });

  async function api(path, opts = {}) {
    const r = await fetch(path, { credentials: "include", ...opts });
    if (r.status === 401) {
      window.location.href = "/login";
      return null;
    }
    if (r.status === 403) {
      window.location.href = "/setup";
      return null;
    }
    return r;
  }

  async function loadCronjobs() {
    const r = await api("/api/cronjobs");
    if (!r) return;
    const list = await r.json();
    const tbody = document.getElementById("cronjobList");
    tbody.innerHTML =
      list.length === 0
        ? '<tr><td colspan="8" class="text-muted">Chưa có cronjob</td></tr>'
        : list
            .map(
              (j) => `
      <tr>
        <td>${j.id}</td>
        <td>${escapeHtml(j.name)}</td>
        <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;" title="${escapeHtml(
          j.url
        )}">${escapeHtml(j.url)}</td>
        <td>${j.method}</td>
        <td><code>${escapeHtml(j.cron_expression)}</code></td>
        <td>${
          j.enable_log
            ? '<span class="badge badge-success">Bật</span>'
            : '<span class="badge badge-warning">Tắt</span>'
        }</td>
        <td>${
          j.enabled
            ? '<span class="badge badge-success">Active</span>'
            : '<span class="badge badge-danger">Tắt</span>'
        }</td>
        <td class="cron-actions">
          <button class="btn btn-sm btn-secondary" onclick="runJob(${
            j.id
          })">Chạy</button>
          <button class="btn btn-sm btn-secondary" onclick="editJob(${
            j.id
          })">Sửa</button>
          <button class="btn btn-sm btn-secondary" onclick="showLogs(${
            j.id
          }, '${String(escapeHtml(j.name)).replace(/'/g, "\\'")}', ${
                j.enable_log
              })" title="${
                j.enable_log ? "Xem log" : "Bật log để xem"
              }">Log</button>
          <button class="btn btn-sm btn-danger" onclick="deleteJob(${
            j.id
          })">Xóa</button>
        </td>
      </tr>
    `
            )
            .join("");
  }

  function escapeHtml(s) {
    if (!s) return "";
    const d = document.createElement("div");
    d.textContent = s;
    return d.innerHTML;
  }

  function buildCron() {
    const mode =
      document.querySelector('input[name="cron_mode"]:checked')?.value ||
      "preset";
    let expr = "";
    if (mode === "preset")
      expr = document.querySelector('[name="cron_preset"]').value;
    else if (mode === "custom") {
      const s = document.querySelector('[name="cron_sec"]');
      const m = document.querySelector('[name="cron_min"]').value;
      const h = document.querySelector('[name="cron_hour"]').value;
      const d = document.querySelector('[name="cron_day"]').value;
      const mo = document.querySelector('[name="cron_month"]').value;
      const w = document.querySelector('[name="cron_dow"]').value;
      expr = s
        ? [s.value, m, h, d, mo, w].join(" ")
        : [m, h, d, mo, w].join(" ");
    } else expr = document.querySelector('[name="cron_manual"]').value.trim();
    document.querySelector('[name="cron_expression"]').value = expr;
    document.getElementById("cronPreview").textContent = expr || "(chưa chọn)";
    return expr;
  }
  function setCronUI(expr) {
    if (!expr) return;
    const setMode = (mode) => {
      document.querySelector(
        `input[name="cron_mode"][value="${mode}"]`
      ).checked = true;
      document
        .getElementById("cronPreset")
        .classList.toggle("hidden", mode !== "preset");
      document
        .getElementById("cronCustom")
        .classList.toggle("hidden", mode !== "custom");
      document
        .getElementById("cronManual")
        .classList.toggle("hidden", mode !== "manual");
    };
    const sel = document.querySelector('[name="cron_preset"]');
    const hasPreset = Array.from(sel.options).some((o) => o.value === expr);
    if (hasPreset) {
      setMode("preset");
      sel.value = expr;
    } else {
      const parts = expr.trim().split(/\s+/);
      if (parts.length >= 5) {
        setMode("custom");
        const setSelect = (name, val) => {
          const el = document.querySelector(`[name="${name}"]`);
          if (el && Array.from(el.options).some((o) => o.value === val))
            el.value = val;
        };
        if (parts.length === 6) {
          setSelect("cron_sec", parts[0]);
          setSelect("cron_min", parts[1]);
          setSelect("cron_hour", parts[2]);
          setSelect("cron_day", parts[3]);
          setSelect("cron_month", parts[4]);
          setSelect("cron_dow", parts[5]);
        } else {
          setSelect("cron_min", parts[0]);
          setSelect("cron_hour", parts[1]);
          setSelect("cron_day", parts[2]);
          setSelect("cron_month", parts[3]);
          setSelect("cron_dow", parts[4]);
        }
      } else {
        setMode("manual");
        document.querySelector('[name="cron_manual"]').value = expr;
      }
    }
    buildCron();
  }
  function initCronMode() {
    document.querySelectorAll('input[name="cron_mode"]').forEach((r) => {
      r.addEventListener("change", () => {
        document
          .getElementById("cronPreset")
          .classList.toggle("hidden", r.value !== "preset");
        document
          .getElementById("cronCustom")
          .classList.toggle("hidden", r.value !== "custom");
        document
          .getElementById("cronManual")
          .classList.toggle("hidden", r.value !== "manual");
        buildCron();
      });
    });
    document
      .querySelector('[name="cron_preset"]')
      .addEventListener("change", buildCron);
    [
      "cron_sec",
      "cron_min",
      "cron_hour",
      "cron_day",
      "cron_month",
      "cron_dow",
    ].forEach((n) => {
      const el = document.querySelector(`[name="${n}"]`);
      if (el) el.addEventListener("change", buildCron);
    });
    document
      .querySelector('[name="cron_manual"]')
      .addEventListener("input", buildCron);
  }

  document.getElementById("btnAdd").addEventListener("click", () => {
    document.getElementById("modalTitle").textContent = "Thêm Cronjob";
    document.getElementById("formCronjob").reset();
    document
      .getElementById("formCronjob")
      .querySelector('[name="enable_log"]').checked = true;
    document.getElementById("enabledCheck").checked = true;
    document.getElementById("formCronjob").querySelector('[name="id"]').value =
      "";
    document.querySelector(
      'input[name="cron_mode"][value="preset"]'
    ).checked = true;
    document.getElementById("cronPreset").classList.remove("hidden");
    document.getElementById("cronCustom").classList.add("hidden");
    document.getElementById("cronManual").classList.add("hidden");
    document.querySelector('[name="cron_preset"]').value = "*/5 * * * *";
    buildCron();
    document.getElementById("modalForm").classList.remove("hidden");
  });

  document.getElementById("btnCancel").addEventListener("click", () => {
    document.getElementById("modalForm").classList.add("hidden");
  });

  document
    .getElementById("formCronjob")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      buildCron();
      const form = e.target;
      const id = form.id.value;
      const data = {
        name: form.name.value,
        url: form.url.value,
        method: form.method.value,
        cron_expression: form.cron_expression.value.trim(),
        enable_log: form.enable_log.checked,
        enabled: form.enabled.checked,
      };
      alertEl.classList.add("hidden");
      successEl.classList.add("hidden");
      try {
        if (id) {
          const r = await api(`/api/cronjobs/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          if (!r || !r.ok) throw new Error("Update failed");
          successEl.textContent = "Đã cập nhật";
        } else {
          const r = await api("/api/cronjobs", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ...data, enabled: true }),
          });
          if (!r || !r.ok) throw new Error("Create failed");
          successEl.textContent = "Đã thêm cronjob";
        }
        successEl.classList.remove("hidden");
        document.getElementById("modalForm").classList.add("hidden");
        loadCronjobs();
      } catch (err) {
        alertEl.textContent = err.message;
        alertEl.classList.remove("hidden");
      }
    });

  async function editJob(id) {
    const r = await api(`/api/cronjobs/${id}`);
    if (!r) return;
    const j = await r.json();
    const form = document.getElementById("formCronjob");
    form.id.value = j.id;
    form.name.value = j.name;
    form.url.value = j.url;
    form.method.value = j.method;
    form.enable_log.checked = j.enable_log;
    form.enabled.checked = j.enabled;
    setCronUI(j.cron_expression);
    document.getElementById("modalTitle").textContent = "Sửa Cronjob";
    document.getElementById("modalForm").classList.remove("hidden");
  }

  async function deleteJob(id) {
    if (!confirm("Xóa cronjob này?")) return;
    const r = await api(`/api/cronjobs/${id}`, { method: "DELETE" });
    if (!r || !r.ok) return;
    successEl.textContent = "Đã xóa";
    successEl.classList.remove("hidden");
    loadCronjobs();
  }

  async function runJob(id) {
    const r = await api(`/api/cronjobs/${id}/run`, { method: "POST" });
    if (!r || !r.ok) return;
    successEl.textContent = "Đã chạy";
    successEl.classList.remove("hidden");
    setTimeout(() => successEl.classList.add("hidden"), 2000);
  }

  async function showLogs(id, name, hasLog) {
    document.getElementById("logJobName").textContent = name;
    document.getElementById("modalLogs").classList.remove("hidden");
    if (!hasLog) {
      document.getElementById("logList").innerHTML =
        '<p class="text-muted">Cronjob chưa bật log. Bật log trong phần Sửa để ghi lại lịch sử chạy.</p>';
      return;
    }
    const r = await api(`/api/cronjobs/${id}/logs`);
    if (!r) return;
    const j = await r.json();
    const list = j.logs || [];
    document.getElementById("logList").innerHTML =
      list.length === 0
        ? '<p class="text-muted">Chưa có log</p>'
        : list
            .map(
              (l) => `
      <div class="log-item">
        <div class="log-meta">${l.executed_at} | ${l.status} | ${
                l.status_code || "-"
              } | ${l.duration_ms || "-"}ms</div>
        ${
          l.error ? `<div class="text-danger">${escapeHtml(l.error)}</div>` : ""
        }
        ${
          l.output
            ? `<div class="log-output">${escapeHtml(l.output)}</div>`
            : ""
        }
      </div>
    `
            )
            .join("");
  }

  document.getElementById("btnCloseLogs").addEventListener("click", () => {
    document.getElementById("modalLogs").classList.add("hidden");
  });

  initCronMode();
  loadCronjobs();
</script>
{% endblock %}
