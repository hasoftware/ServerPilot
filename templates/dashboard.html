{% extends "base.html" %} {% block title %}Dashboard - Control Server{% endblock
%} {% block body %}
<div class="app-shell">
  <aside class="sidebar">
    <div style="padding: 0 1.5rem 1rem; font-weight: 600">Control Server</div>
    <nav>
      <a href="/dashboard" class="active">Dashboard</a>
      <a href="/cronjobs">Cronjob Manager</a>
      <a href="/logs">Log Server</a>
      <a href="/services">Services</a>
      <a href="/terminal">Terminal</a>
      <a href="#" id="logoutLink">Đăng xuất</a>
    </nav>
  </aside>
  <main class="main">
    <h1 style="margin-bottom: 1.5rem">
      Dashboard
      <span
        id="lastUpdate"
        class="text-muted"
        style="font-size: 0.75rem; font-weight: 400"
      ></span>
    </h1>
    <div class="metrics-grid" id="metrics"></div>
    <div class="card">
      <h2>Biểu đồ sử dụng tài nguyên</h2>
      <div
        class="charts-grid"
        style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
          gap: 1.5rem;
          margin-top: 1rem;
        "
      >
        <div>
          <h3 style="font-size: 0.9rem; margin-bottom: 0.5rem">CPU %</h3>
          <canvas id="chartCpu" height="120"></canvas>
        </div>
        <div>
          <h3 style="font-size: 0.9rem; margin-bottom: 0.5rem">RAM %</h3>
          <canvas id="chartRam" height="120"></canvas>
        </div>
        <div>
          <h3 style="font-size: 0.9rem; margin-bottom: 0.5rem">Disk %</h3>
          <canvas id="chartDisk" height="120"></canvas>
        </div>
      </div>
    </div>
    <div class="card">
      <h2>Thông tin server</h2>
      <div id="metricsDetail" class="text-muted">Đang tải...</div>
    </div>
  </main>
</div>
{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  document.getElementById("logoutLink").addEventListener("click", async (e) => {
    e.preventDefault();
    await fetch("/api/auth/logout", { method: "POST", credentials: "include" });
    window.location.href = "/login";
  });

  const MAX_POINTS = 30;
  const history = { labels: [], cpu: [], ram: [], disk: [] };
  const chartOpts = {
    responsive: true,
    maintainAspectRatio: false,
    animation: false,
    scales: { x: { display: false }, y: { min: 0, max: 100 } },
  };

  let chartCpu, chartRam, chartDisk;
  function initCharts() {
    const bg = "rgba(34,197,94,0.2)";
    const border = "#22c55e";
    chartCpu = new Chart(document.getElementById("chartCpu"), {
      type: "line",
      data: {
        labels: history.labels,
        datasets: [
          {
            label: "CPU %",
            data: history.cpu,
            borderColor: border,
            backgroundColor: bg,
            fill: true,
            tension: 0.3,
          },
        ],
      },
      options: chartOpts,
    });
    chartRam = new Chart(document.getElementById("chartRam"), {
      type: "line",
      data: {
        labels: history.labels,
        datasets: [
          {
            label: "RAM %",
            data: history.ram,
            borderColor: "#3b82f6",
            backgroundColor: "rgba(59,130,246,0.2)",
            fill: true,
            tension: 0.3,
          },
        ],
      },
      options: chartOpts,
    });
    chartDisk = new Chart(document.getElementById("chartDisk"), {
      type: "line",
      data: {
        labels: history.labels,
        datasets: [
          {
            label: "Disk %",
            data: history.disk,
            borderColor: "#f59e0b",
            backgroundColor: "rgba(245,158,11,0.2)",
            fill: true,
            tension: 0.3,
          },
        ],
      },
      options: chartOpts,
    });
  }
  function updateCharts(m) {
    const t = new Date().toLocaleTimeString("vi-VN", {
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });
    history.labels.push(t);
    history.cpu.push(m.cpu_percent);
    history.ram.push(m.memory_percent);
    history.disk.push(m.disk_percent);
    if (history.labels.length > MAX_POINTS) {
      history.labels.shift();
      history.cpu.shift();
      history.ram.shift();
      history.disk.shift();
    }
    if (chartCpu) {
      chartCpu.data.labels = history.labels;
      chartCpu.data.datasets[0].data = history.cpu;
      chartCpu.update("none");
    }
    if (chartRam) {
      chartRam.data.labels = history.labels;
      chartRam.data.datasets[0].data = history.ram;
      chartRam.update("none");
    }
    if (chartDisk) {
      chartDisk.data.labels = history.labels;
      chartDisk.data.datasets[0].data = history.disk;
      chartDisk.update("none");
    }
  }

  async function loadMetrics() {
    const r = await fetch("/api/dashboard/metrics", { credentials: "include" });
    if (r.status === 401) {
      window.location.href = "/login";
      return;
    }
    if (r.status === 403) {
      window.location.href = "/setup";
      return;
    }
    const m = await r.json();
    document.getElementById("metrics").innerHTML = `
    <div class="metric-card"><div class="label">Uptime</div><div class="value">${m.uptime}</div></div>
    <div class="metric-card"><div class="label">CPU</div><div class="value">${m.cpu_percent}%</div></div>
    <div class="metric-card"><div class="label">RAM</div><div class="value">${m.memory_percent}%</div></div>
    <div class="metric-card"><div class="label">Disk</div><div class="value">${m.disk_percent}%</div></div>
    <div class="metric-card"><div class="label">Cronjob Active</div><div class="value">${m.active_cronjobs}</div></div>
  `;
    document.getElementById("metricsDetail").innerHTML = `
    RAM: ${m.memory_used_gb} / ${m.memory_total_gb} GB<br>
    Disk: ${m.disk_used_gb} / ${m.disk_total_gb} GB
  `;
    document.getElementById("lastUpdate").textContent =
      "Cập nhật: " + new Date().toLocaleTimeString("vi-VN");
    updateCharts(m);
  }
  initCharts();
  loadMetrics();
  setInterval(loadMetrics, 3000);
</script>
{% endblock %}
