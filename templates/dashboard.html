{% extends "base.html" %} {% block title %}Dashboard - Control Server{% endblock
%} {% block body %}
<div class="app-shell">
  <aside class="sidebar">
    <div style="padding: 0 1.5rem 1rem; font-weight: 600">Control Server</div>
    <nav>
      <a href="/dashboard" class="active">Dashboard</a>
      <a href="/cronjobs">Cronjob Manager</a>
      <a href="/logs">Log Server</a>
      <a href="/services">Services</a>
      <a href="/vnc">Console</a>
      <a href="#" id="logoutLink">Đăng xuất</a>
    </nav>
  </aside>
  <main class="main">
    <h1 style="margin-bottom: 1.5rem">
      Dashboard
      <span
        id="lastUpdate"
        class="text-muted"
        style="font-size: 0.75rem; font-weight: 400"
      ></span>
    </h1>
    <div class="metrics-grid" id="metrics"></div>
    <div class="card">
      <h2>Biểu đồ sử dụng tài nguyên</h2>
      <div
        class="charts-grid"
        style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 1.5rem;
          margin-top: 1rem;
        "
      >
        <div style="height: 180px; overflow: hidden">
          <h3 style="font-size: 0.9rem; margin-bottom: 0.5rem">CPU %</h3>
          <div style="height: 140px; position: relative; overflow: hidden">
            <canvas id="chartCpu"></canvas>
          </div>
        </div>
        <div style="height: 180px; overflow: hidden">
          <h3 style="font-size: 0.9rem; margin-bottom: 0.5rem">RAM %</h3>
          <div style="height: 140px; position: relative; overflow: hidden">
            <canvas id="chartRam"></canvas>
          </div>
        </div>
        <div style="height: 180px; overflow: hidden">
          <h3 style="font-size: 0.9rem; margin-bottom: 0.5rem">Disk %</h3>
          <div style="height: 140px; position: relative; overflow: hidden">
            <canvas id="chartDisk"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <h2>Thông tin server</h2>
      <div id="metricsDetail" class="text-muted">Đang tải...</div>
    </div>
  </main>
</div>
{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  document.getElementById("logoutLink").addEventListener("click", async (e) => {
    e.preventDefault();
    await fetch("/api/auth/logout", { method: "POST", credentials: "include" });
    window.location.href = "/login";
  });

  let chartCpu, chartRam, chartDisk;
  const chartOpts = { responsive: true, maintainAspectRatio: false };
  function initCharts() {
    chartCpu = new Chart(document.getElementById("chartCpu"), {
      type: "doughnut",
      data: {
        labels: ["Đã dùng", "Còn trống"],
        datasets: [
          {
            data: [0, 100],
            backgroundColor: ["#22c55e", "#2a2a32"],
            borderWidth: 0,
          },
        ],
      },
      options: { ...chartOpts, plugins: { legend: { position: "bottom" } } },
    });
    chartRam = new Chart(document.getElementById("chartRam"), {
      type: "doughnut",
      data: {
        labels: ["Đã dùng", "Còn trống"],
        datasets: [
          {
            data: [0, 100],
            backgroundColor: ["#3b82f6", "#2a2a32"],
            borderWidth: 0,
          },
        ],
      },
      options: { ...chartOpts, plugins: { legend: { position: "bottom" } } },
    });
    chartDisk = new Chart(document.getElementById("chartDisk"), {
      type: "doughnut",
      data: {
        labels: ["Đã dùng", "Còn trống"],
        datasets: [
          {
            data: [0, 100],
            backgroundColor: ["#f59e0b", "#2a2a32"],
            borderWidth: 0,
          },
        ],
      },
      options: { ...chartOpts, plugins: { legend: { position: "bottom" } } },
    });
  }
  function updateCharts(m) {
    const set = (chart, used) => {
      if (chart) {
        chart.data.datasets[0].data = [used, 100 - used];
        chart.update("none");
      }
    };
    set(chartCpu, m.cpu_percent);
    set(chartRam, m.memory_percent);
    set(chartDisk, m.disk_percent);
  }

  async function loadMetrics() {
    const r = await fetch("/api/dashboard/metrics", { credentials: "include" });
    if (r.status === 401) {
      window.location.href = "/login";
      return;
    }
    if (r.status === 403) {
      window.location.href = "/setup";
      return;
    }
    const m = await r.json();
    document.getElementById("metrics").innerHTML = `
    <div class="metric-card"><div class="label">Uptime</div><div class="value">${m.uptime}</div></div>
    <div class="metric-card"><div class="label">CPU</div><div class="value">${m.cpu_percent}%</div></div>
    <div class="metric-card"><div class="label">RAM</div><div class="value">${m.memory_percent}%</div></div>
    <div class="metric-card"><div class="label">Disk</div><div class="value">${m.disk_percent}%</div></div>
    <div class="metric-card"><div class="label">Cronjob Active</div><div class="value">${m.active_cronjobs}</div></div>
  `;
    document.getElementById("metricsDetail").innerHTML = `
    RAM: ${m.memory_used_gb} / ${m.memory_total_gb} GB<br>
    Disk: ${m.disk_used_gb} / ${m.disk_total_gb} GB
  `;
    document.getElementById("lastUpdate").textContent =
      "Cập nhật: " + new Date().toLocaleTimeString("vi-VN");
    updateCharts(m);
  }
  initCharts();
  loadMetrics();
  setInterval(loadMetrics, 3000);
</script>
{% endblock %}
