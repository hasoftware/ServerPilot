{% extends "base.html" %} {% block title %}VNC Viewer - Control Server{%
endblock %} {% block body %}
<div class="app-shell">
  <aside class="sidebar">
    <div style="padding: 0 1.5rem 1rem; font-weight: 600">Control Server</div>
    <nav>
      <a href="/dashboard">Dashboard</a>
      <a href="/cronjobs">Cronjob Manager</a>
      <a href="/logs">Log Server</a>
      <a href="/services">Services</a>
      <a href="/vnc" class="active">Console</a>
      <a href="#" id="logoutLink">Đăng xuất</a>
    </nav>
  </aside>
  <main class="main">
    <h1>Console / Terminal</h1>
    <p class="text-muted mb-3">
      Console dạng VNC – tương tự Proxmox. Có thể gõ lệnh trực tiếp.
    </p>
    <div id="vncToolbar" class="mb-2 flex gap-1" style="display:none;">
      <button type="button" class="btn btn-secondary btn-sm" id="btnCtrlC" title="Thoát top, v.v.">Gửi Ctrl+C</button>
    </div>
    <div id="vncBox" class="card">
      <div
        id="vncScreen"
        style="
          width: 100%;
          height: 70vh;
          background: #1a1a1a;
          border-radius: var(--radius);
          display: flex;
          align-items: center;
          justify-content: center;
          overflow: hidden;
        "
      >
        <div id="vncPlaceholder" class="text-muted text-center p-4">
          <p>Đang tải VNC...</p>
        </div>
      </div>
    </div>
  </main>
</div>
{% endblock %} {% block scripts %}
<script type="module">
  document.getElementById("logoutLink").addEventListener("click", async (e) => {
    e.preventDefault();
    await fetch("/api/auth/logout", { method: "POST", credentials: "include" });
    window.location.href = "/login";
  });

  async function initVNC() {
    const r = await fetch("/api/server/vnc-url", { credentials: "include" });
    if (r.status === 401) {
      window.location.href = "/login";
      return;
    }
    const j = await r.json();
    const wsUrl = j.url;
    if (!wsUrl) {
      document.getElementById("vncPlaceholder").innerHTML =
        '<p class="text-danger">Chưa cấu hình VNC_WS_URL trong .env</p><p>Cài websockify: <code>pip install websockify</code>, chạy: <code>websockify 6080 localhost:5901</code></p>';
      return;
    }
    try {
      const RFB = (
        await import(
          "https://cdn.jsdelivr.net/npm/@novnc/novnc@1.4.0/core/rfb.js"
        )
      ).default;
      document.getElementById("vncPlaceholder").remove();
      const rfb = new RFB(document.getElementById("vncScreen"), wsUrl, {
        credentials: { password: "" },
      });
      rfb.viewOnly = false;
      rfb.addEventListener("connect", () => {
        document.title = "VNC - Đã kết nối";
        document.getElementById("vncToolbar").style.display = "flex";
      });
      rfb.addEventListener("disconnect", () => {
        document.title = "VNC Viewer - Control Server";
        document.getElementById("vncToolbar").style.display = "none";
      });
      document.getElementById("btnCtrlC").addEventListener("click", () => {
        const K = { Ctrl: 0xffe3, c: 0x0063 };
        rfb.sendKey(K.Ctrl, "ControlLeft", true);
        rfb.sendKey(K.c, "KeyC", true);
        rfb.sendKey(K.c, "KeyC", false);
        rfb.sendKey(K.Ctrl, "ControlLeft", false);
      });
    } catch (err) {
      document.getElementById("vncPlaceholder").innerHTML =
        '<p class="text-danger">Lỗi kết nối VNC: ' +
        err.message +
        "</p><p>Kiểm tra VNC server + websockify đang chạy, và VNC_WS_URL trong .env (vd: ws://localhost:6080)</p>";
    }
  }
  initVNC();
</script>
{% endblock %}
